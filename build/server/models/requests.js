// Generated by CoffeeScript 1.9.1
var cozydb, emit;

cozydb = require('cozydb');

emit = null;

module.exports = {
  settings: {
    all: cozydb.defaultRequests.all
  },
  account: {
    all: cozydb.defaultRequests.all
  },
  contact: {
    all: cozydb.defaultRequests.all,
    mailByName: function(doc) {
      var dp, i, len, ref, results;
      if ((doc.fn != null) && doc.fn.length > 0) {
        emit(doc.fn, doc);
      }
      if (doc.n != null) {
        emit(doc.n.split(';').join(' ').trim(), doc);
      }
      ref = doc.datapoints;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        dp = ref[i];
        if (dp.name === 'email') {
          emit(dp.value, doc);
          results.push(emit(dp.value.split('@')[1], doc));
        } else {
          results.push(void 0);
        }
      }
      return results;
    },
    mailByEmail: function(doc) {
      var dp, i, len, ref, results;
      ref = doc.datapoints;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        dp = ref[i];
        if (dp.name === 'email') {
          results.push(emit(dp.value, doc));
        } else {
          results.push(void 0);
        }
      }
      return results;
    }
  },
  mailbox: {
    treeMap: function(doc) {
      return emit([doc.accountID].concat(doc.tree), null);
    }
  },
  message: {
    totalUnreadByAccount: {
      reduce: '_count',
      map: function(doc) {
        if (!doc.ignoreInCount && -1 === doc.flags.indexOf('\\Seen')) {
          return emit(doc.accountID, null);
        }
      }
    },
    byMailboxRequest: {
      reduce: '_count',
      map: function(doc) {
        var boxid, dest, dests, docDate, i, j, k, len, len1, len2, nobox, ref, ref1, ref2, ref3, sender, uid, xflag;
        nobox = true;
        ref = doc.mailboxIDs;
        for (boxid in ref) {
          uid = ref[boxid];
          nobox = false;
          docDate = doc.date || (new Date()).toISOString();
          emit(['uid', boxid, uid], doc.flags);
          emit(['date', boxid, null, docDate], null);
          emit(['subject', boxid, null, doc.normSubject], null);
          ref1 = ['\\Seen', '\\Flagged', '\\Answered'];
          for (i = 0, len = ref1.length; i < len; i++) {
            xflag = ref1[i];
            if (-1 === doc.flags.indexOf(xflag)) {
              xflag = '!' + xflag;
            }
            emit(['date', boxid, xflag, docDate], null);
            emit(['subject', boxid, xflag, doc.normSubject], null);
          }
          if (((ref2 = doc.attachments) != null ? ref2.length : void 0) > 0) {
            emit(['date', boxid, '\\Attachments', docDate], null);
            emit(['subject', boxid, '\\Attachments', doc.normSubject], null);
          }
          ref3 = doc.from;
          for (j = 0, len1 = ref3.length; j < len1; j++) {
            sender = ref3[j];
            if (sender.name != null) {
              emit(['from', boxid, null, sender.name, docDate], null);
            }
            emit(['from', boxid, null, sender.address, docDate], null);
          }
          dests = [];
          if (doc.to != null) {
            dests = dests.concat(doc.to);
          }
          if (doc.cc != null) {
            dests = dests.concat(doc.cc);
          }
          for (k = 0, len2 = dests.length; k < len2; k++) {
            dest = dests[k];
            if (dest.name != null) {
              emit(['dest', boxid, null, dest.name, docDate], null);
            }
            emit(['dest', boxid, null, dest.address, docDate], null);
          }
        }
        void 0;
        if (nobox) {
          return emit(['nobox']);
        }
      }
    },
    dedupRequest: function(doc) {
      if (doc.messageID) {
        emit([doc.accountID, 'mid', doc.messageID], doc.conversationID);
      }
      if (doc.normSubject) {
        return emit([doc.accountID, 'subject', doc.normSubject], doc.conversationID);
      }
    },
    byConversationID: {
      reduce: '_count',
      map: function(doc) {
        if (doc.conversationID && !doc.ignoreInCount) {
          return emit(doc.conversationID);
        }
      }
    }
  }
};
